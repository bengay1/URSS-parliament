---
title: "URSS collecting everything"
author: "Benjamin Gay"
date: "2025-08-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tibble)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ltm)
library(lubridate)
library(tidyverse)
library(stringr)
```


## 2024/2025 function to find rate of agreement

```{r}
# Load MP metadata and vote matrix
mps_2024 <- read.delim("https://www.publicwhip.org.uk/data/votematrix-2024.txt", skip = 19)
vm_2024  <- read.delim("https://www.publicwhip.org.uk/data/votematrix-2024.dat")

# Convert date column
vm_2024 <- transform(vm_2024, date = as.Date(date))

# Reshape vote matrix
vote_data_long_2024 <- vm_2024 %>%
  pivot_longer(
    cols = starts_with("mpid"),
    names_to = "mpid",
    values_to = "vote_code"
  ) %>%
  mutate(mpid = as.integer(sub("mpid", "", mpid)))  # Extract numeric mpid

colnames(mps_2024)[1] <- "mpid"

# Merge vote data with MP metadata
vote_data_long_2024 <- vote_data_long_2024 %>%
  left_join(mps_2024, by = "mpid")

# Clean vote data
vote_data_clean_2024 <- vote_data_long_2024 %>%
  filter(!vote_code %in% c(-9, 3)) %>%                  
  filter(!grepl("\\[Lords\\]", Bill)) %>%                
  mutate(
    vote_code = case_when(                           
      vote_code == 1 ~ 2,   # tellaye → aye
      vote_code == 5 ~ 4,   # tellno  → no
      TRUE ~ vote_code
    ),
    vote_label = case_when(                              
      vote_code == 2 ~ "Aye",
      vote_code == 4 ~ "No",
      TRUE ~ NA_character_
    ),
    mp_unique_id = paste(firstname, surname, mpid, sep = "_")  # Unique and clear
  )

# Remove duplicate pairs
vote_data_dedup_2024 <- vote_data_clean_2024 %>%
  distinct(mpid, voteno, .keep_all = TRUE)

# Add binary vote
vote_data_dedup_2024 <- vote_data_dedup_2024 %>%
  mutate(vote_binary = ifelse(vote_code == 2, 1, 0))

# Pivot to wide format
irt_matrix_2024 <- vote_data_dedup_2024 %>%
  dplyr::select(mp_unique_id, party, voteno, vote_binary) %>%
  pivot_wider(names_from = voteno, values_from = vote_binary)

irt_matrix_2024 <- irt_matrix_2024 %>%
  relocate(party, .after = mp_unique_id) %>%                 
  column_to_rownames("mp_unique_id")                         

# Check final result
print(dim(irt_matrix_2024))
head(irt_matrix_2024[, 1:10])


plot_mp_agreement_2024 <- function(mp_id, irt_matrix_2024) {
  # Check if MP exists
  if (!(mp_id %in% rownames(irt_matrix_2024))) {
    stop("MP not found in the dataset.")
  }
  
  vote_cols <- which(sapply(irt_matrix_2024, is.numeric))
  
  target_votes <- unlist(irt_matrix_2024[mp_id, vote_cols])
  
  # Compute agreement rates
  comparison_df <- irt_matrix_2024 %>%
    rownames_to_column("mp_id") %>%
    filter(mp_id != !!mp_id) %>%
    rowwise() %>%
    mutate(
      agreement = sum(
        !is.na(c_across(all_of(names(target_votes)))) &
          !is.na(target_votes) &
          c_across(all_of(names(target_votes))) == target_votes,
        na.rm = TRUE
      ),
      total_overlap = sum(
        !is.na(c_across(all_of(names(target_votes)))) & !is.na(target_votes),
        na.rm = TRUE
      ),
      agreement_rate = ifelse(total_overlap > 0, agreement / total_overlap, NA_real_)
    ) %>%
    ungroup()
  
  # Return data frame
  agreement_data <- comparison_df %>%
    dplyr::select(mp_id, party, agreement_rate) %>%
    arrange(desc(agreement_rate))
  
  # Plot agreement rates
  plot <- ggplot(agreement_data, aes(x = reorder(mp_id, agreement_rate), y = agreement_rate, color = party)) +
    geom_point(alpha = 0.7) +
    coord_flip() +
    labs(
      title = paste("Vote Agreement Rates with", mp_id),
      x = "MP",
      y = "Agreement Rate",
      color = "Party"
    ) +
    theme_minimal() +
    theme(axis.text.y = element_blank(),  # Hide MP labels on y-axis for clarity
          axis.ticks.y = element_blank())
  
  print(plot)
  
  return(agreement_data)
}

results_2024 <- plot_mp_agreement_2024("Bridget_Phillipson_42782", irt_matrix_2024)
head(results_2024)
```

## 2010 example analysis

```{r}
mps_2010 <- read.delim("https://www.publicwhip.org.uk/data/votematrix-2010.txt", skip = 19)
vm_2010 <- read.delim("https://www.publicwhip.org.uk/data/votematrix-2010.dat")

vm_2010 <- transform(vm_2010, date = as.Date(date))

# Reshape vote matrix
vote_data_long_2010 <- vm_2010 %>%
  pivot_longer(
    cols = starts_with("mpid"),
    names_to = "mpid",
    values_to = "vote_code"
  ) %>%
  mutate(mpid = as.integer(sub("mpid", "", mpid)))

colnames(mps_2010)[1] <- "mpid"

# Merge vote data with MP metadata
vote_data_long_2010 <- vote_data_long_2010 %>%
  left_join(mps_2010, by = "mpid")

# Clean vote data
vote_data_clean_2010 <- vote_data_long_2010 %>%
  filter(!vote_code %in% c(-9, 3)) %>%                    
  filter(!grepl("\\[Lords\\]", Bill)) %>%                 
  mutate(
    vote_code = case_when(                                
      vote_code == 1 ~ 2,
      vote_code == 5 ~ 4,
      TRUE ~ vote_code
    ),
    vote_label = case_when(
      vote_code == 2 ~ "Aye",
      vote_code == 4 ~ "No",
      TRUE ~ NA_character_
    ),
    mp_unique_id = paste(firstname, surname, mpid, sep = "_")
  )

vote_data_dedup_2010 <- vote_data_clean_2010 %>%
  distinct(mpid, voteno, .keep_all = TRUE) %>%
  mutate(vote_binary = ifelse(vote_code == 2, 1, 0))

# Pivot to IRT wide matrix
irt_matrix_2010 <- vote_data_dedup_2010 %>%
  dplyr::select(mp_unique_id, party, voteno, vote_binary) %>%
  pivot_wider(names_from = voteno, values_from = vote_binary) %>%
  relocate(party, .after = mp_unique_id) %>%
  column_to_rownames("mp_unique_id")

# Filter Jeremy Corbyn votes from 2010 data
jeremy_votes_2010 <- vote_data_long_2010 %>%
  dplyr::filter(firstname == "Jeremy", surname == "Corbyn") %>%
  dplyr::select(voteno, jeremy_vote_code = vote_code)

vote_compare_2010 <- vote_data_long_2010 %>%
  left_join(jeremy_votes_2010, by = "voteno") %>%
  mutate(
    agreement = ifelse(vote_code == jeremy_vote_code, 1, 0),
    mp_unique_id = paste(firstname, surname, mpid, sep = "_")
  )

# Create agreement matrix
agreement_matrix_2010 <- vote_compare_2010 %>%
  dplyr::select(mp_unique_id, voteno, agreement) %>%
  distinct() %>%
  group_by(mp_unique_id, voteno) %>%
  summarize(agreement = mean(agreement), .groups = 'drop') %>%
  tidyr::pivot_wider(names_from = voteno, values_from = agreement) %>%
  column_to_rownames("mp_unique_id") %>%
  as.matrix()

# Clean agreement matrix
agreement_matrix_clean_2010 <- agreement_matrix_2010[
  rowSums(is.na(agreement_matrix_2010)) < ncol(agreement_matrix_2010) * 0.5, 
  colSums(is.na(agreement_matrix_2010)) < nrow(agreement_matrix_2010) * 0.5
]

# Imput remaining NAs with 0
agreement_matrix_clean_2010[is.na(agreement_matrix_clean_2010)] <- 0

agreement_matrix_clean_2010 <- ifelse(agreement_matrix_clean_2010 > 0.5, 1, 0)

# Prepare IRT data
irt_data_2010 <- as.data.frame(agreement_matrix_clean_2010)

# Calculate mean agreement per vote
vote_means <- colMeans(agreement_matrix_clean_2010, na.rm = TRUE)
keep_cols <- which(vote_means > 0.1 & vote_means < 0.9)
filtered_data <- irt_data_2010[, keep_cols, drop = FALSE]

# Fit the 2PL IRT model
irt_model_2010 <- ltm(filtered_data ~ z1, IRT.param = TRUE)
summary(irt_model_2010)

plot(irt_model_2010, type = "ICC")

# Extract ideology scores
mp_scores_2010 <- factor.scores(irt_model_2010, resp.patterns = filtered_data)
mp_scores_full_2010 <- mp_scores_2010$score.dat %>%
  tibble::rownames_to_column("mp_unique_id") %>%
  dplyr::select(mp_unique_id, ideology_score = z1)

# Get metadata
mp_metadata_2010 <- vote_compare_2010 %>%
  distinct(mp_unique_id, firstname, surname, party) %>%
  mutate(
    MPName = paste(firstname, surname),
    Party = party
  ) %>%
  dplyr::select(mp_unique_id, MPName, Party)

mp_scores_full_2010 <- mp_scores_full_2010 %>%
  left_join(mp_metadata_2010, by = "mp_unique_id") %>%
  arrange(ideology_score) %>%
  mutate(
    MPName_factor = factor(mp_unique_id, levels = mp_unique_id)
  )

# Plot ideology scores
ggplot(mp_scores_full_2010, aes(x = ideology_score, y = MPName_factor, color = Party)) +
  geom_point() +
  theme_minimal() +
  labs(
    title = "MP Ideological Scores Based on Voting Alignment with Jeremy Corbyn (2010)",
    x = "Ideology Score (θ)",
    y = NULL
  ) +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "bottom"
  ) +
  scale_color_manual(values = RColorBrewer::brewer.pal(n = length(unique(mp_scores_full_2010$Party)), name = "Paired"))


mp_scores_full_2010 %>%
  filter(!grepl("Jeremy_Corbyn", mp_unique_id)) %>%
  arrange(desc(ideology_score)) %>%  # Added desc() for descending order
  dplyr::select(MPName, Party, ideology_score) %>%
  head(10) %>%
  knitr::kable(digits = 2)


```

## 2011 vs 2012 z-scores

```{r}
select <- dplyr::select
filter <- dplyr::filter

# Load data
mps_2010 <- read.delim("https://www.publicwhip.org.uk/data/votematrix-2010.txt", skip = 19)
vm_2010 <- read.delim("https://www.publicwhip.org.uk/data/votematrix-2010.dat") %>%
  mutate(date = as.Date(date))

get_yearly_scores <- function(vm_data, mps_data, target_year) {
  # Filter votes for the target year
  yearly_votes <- vm_data %>%
    filter(year(date) == target_year)
  
  if (nrow(yearly_votes) == 0) return(NULL)

  vote_long <- yearly_votes %>%
    pivot_longer(
      cols = starts_with("mpid"),
      names_to = "mpid",
      values_to = "vote_code"
    ) %>%
    mutate(mpid = as.integer(sub("mpid", "", mpid))) %>%
    left_join(mps_data %>% rename(mpid = 1), by = "mpid") %>%
    filter(!vote_code %in% c(-9, 3), !grepl("\\[Lords\\]", Bill)) %>%
    mutate(
      vote_binary = case_when(
        vote_code == 2 ~ 1,
        vote_code == 4 ~ 0,
        TRUE ~ NA_real_
      ),
      mp_unique_id = paste(firstname, surname, mpid, sep = "_")
    ) %>%
    # Proper deduplication
    group_by(mp_unique_id, voteno) %>%
    slice_tail(n = 1) %>%
    ungroup()
  
  # Get Jeremy Corbyn's votes
  jeremy_votes <- vote_long %>%
    filter(firstname == "Jeremy", surname == "Corbyn") %>%
    distinct(voteno, jeremy_vote = vote_binary)
  
  # Create agreement matrix
  agreement_matrix <- vote_long %>%
    left_join(jeremy_votes, by = "voteno", relationship = "many-to-many") %>%
    mutate(agreement = ifelse(vote_binary == jeremy_vote, 1, 0)) %>%
    distinct(mp_unique_id, voteno, agreement) %>%
    pivot_wider(
      names_from = voteno,
      values_from = agreement,
      values_fn = list(agreement = max)  # Take max if duplicates remain
    ) %>%
    column_to_rownames("mp_unique_id") %>%
    as.matrix()
  
  # Clean matrix
  agreement_clean <- agreement_matrix[
    rowSums(is.na(agreement_matrix)) < ncol(agreement_matrix) * 0.5,
    colSums(is.na(agreement_matrix)) < nrow(agreement_matrix) * 0.5
  ]
  agreement_clean[is.na(agreement_clean)] <- 0
  
  # Filter votes
  vote_means <- colMeans(agreement_clean)
  keep_cols <- which(vote_means > 0.1 & vote_means < 0.9)
  filtered_data <- as.data.frame(agreement_clean[, keep_cols, drop = FALSE])
  
  if (ncol(filtered_data) < 5) {
    warning(paste("Not enough valid votes in", target_year))
    return(NULL)
  }
  
  # Fit IRT model
  irt_model <- tryCatch(
    ltm(filtered_data ~ z1, IRT.param = TRUE),
    error = function(e) NULL,
    warning = function(w) NULL
  )
  
  if (is.null(irt_model)) return(NULL)
  
  # Extract scores
  scores <- factor.scores(irt_model, resp.patterns = filtered_data)$score.dat %>%
    rownames_to_column("mp_unique_id") %>%
    select(mp_unique_id, z_score = z1) %>%
    mutate(year = target_year)
  
  # Add MP metadata
  mp_metadata <- vote_long %>%
    distinct(mp_unique_id, firstname, surname, party)
  
  scores <- scores %>%
    left_join(mp_metadata, by = "mp_unique_id") %>%
    mutate(MPName = paste(firstname, surname))
  
  return(scores)
}

# Get scores for each year
years <- 2010:2015
all_scores <- map_dfr(years, ~ {
  message("Processing year: ", .x)
  get_yearly_scores(vm_2010, mps_2010, .x)
})

# Remove NA scores
all_scores <- all_scores %>% filter(!is.na(z_score))

# View results
head(all_scores)

# Filter for 2011 and 2012 scores
scores_2011_2012 <- all_scores %>%
  filter(year %in% c(2011, 2012)) %>%
  select(mp_unique_id, MPName, party, year, z_score) %>%
  pivot_wider(
    names_from = year,
    values_from = z_score,
    names_prefix = "z_"
  ) %>%
  filter(!is.na(z_2011) & !is.na(z_2012))  # Only MPs with scores in both years

# Prepare the data
plot_data <- all_scores %>%
  filter(year %in% c(2011, 2012)) %>%
  select(mp_unique_id, MPName, party, year, z_score) %>%
  pivot_wider(
    names_from = year,
    values_from = z_score,
    names_prefix = "z_"
  ) %>%
  filter(!is.na(z_2011) & !is.na(z_2012)) %>%
  mutate(
    party = factor(party)  # Ensure party is a factor
  )


party_colors <- c(
  "Con" = "#0087DC",  
  "Lab" = "#E4003B",  
  "LDem" = "#FAA61A", 
  "PC" = "#005B54",   
  "Green" = "#6AB023", 
  "SDLP" = "#2AA82C"  
)

# Create the plot
ggplot(plot_data, aes(x = z_2011, y = z_2012, color = party)) +
  geom_point(alpha = 0.8, size = 3) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "gray50") +
  scale_color_manual(values = party_colors) +
  labs(
    title = "MP Ideology Scores: 2011 vs 2012",
    x = "Ideology Score (2011)",
    y = "Ideology Score (2012)",
    color = "Party"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 8)
  ) +
  guides(color = guide_legend(nrow = 2, override.aes = list(size = 4)))

ggplot(plot_data, aes(x = z_2011, y = z_2012, color = party)) +
  geom_point(alpha = 0.8, size = 3) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "gray50") +
  scale_color_manual(values = party_colors) +
  labs(
    title = "MP Ideology Scores: 2011 vs 2012",
    x = "Ideology Score (2011)",
    y = "Ideology Score (2012)",
    color = "Party"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

## Shorter ideology over time

```{r}
confirmed_mps <- c("Michael Fabricant", "Stephen Lloyd", "Philip Hollobone", "Andrew Miller")

# Prepare the data
mp_trends <- all_scores %>%
  filter(MPName %in% confirmed_mps) %>%
  mutate(
    Year = as.numeric(year),
   
    MP_Short = case_when(
      grepl("Fabricant", MPName) ~ "Fabricant",
      grepl("Lloyd", MPName) ~ "Lloyd",
      grepl("Hollobone", MPName) ~ "Hollobone",
      grepl("Miller", MPName) ~ "Miller"
    )
  )

# Create the plot
ggplot(mp_trends, aes(x = Year, y = z_score, color = MP_Short)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  scale_x_continuous(breaks = 2010:2015, limits = c(2010, 2015)) +
  scale_y_continuous(name = "Ideology Score (z-score)") +
  scale_color_manual(values = c("#E41A1C", "#377EB8", "#4DAF4A", "#984EA3")) + # Distinct colors
  labs(
    title = "MP Ideology Scores Over Time (2010-2015)",
    color = "Member of Parliament"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold", size = 14),
    axis.title = element_text(size = 12)
  ) +
  guides(color = guide_legend(nrow = 2))
```

## IRT over every year

```{r}
# Define the election periods we have
election_years <- c(1997, 2001, 2005, 2010, 2015, 2017)

# Function to load and standardize each election period's data
load_election_data <- function(election_year) {
  # Read the data files
  mps <- read.delim(paste0("https://www.publicwhip.org.uk/data/votematrix-", election_year, ".txt"), 
                    skip = 19)
  vm <- read.delim(paste0("https://www.publicwhip.org.uk/data/votematrix-", election_year, ".dat")) %>%
    mutate(date = as.Date(date))
  
  # Process the voting data
  vm_long <- vm %>%
    pivot_longer(cols = starts_with("mpid"), 
                 names_to = "mpid", 
                 values_to = "vote_code") %>%
    mutate(mpid = as.integer(sub("mpid", "", mpid))) %>%
    left_join(mps %>% rename(mpid = 1), by = "mpid") %>%
    mutate(
      election_period = election_year,
      year = lubridate::year(date),
      parliament = case_when(
        election_year == 1997 ~ "1997-2001",
        election_year == 2001 ~ "2001-2005",
        election_year == 2005 ~ "2005-2010",
        election_year == 2010 ~ "2010-2015",
        election_year == 2015 ~ "2015-2017",
        election_year == 2017 ~ "2017-2019"
      )
    )
  
  return(vm_long)
}

# Load all election periods
all_parliaments <- map_dfr(election_years, load_election_data, .progress = TRUE)

# Standardize party names
combined_data <- all_parliaments %>%
  filter(!vote_code %in% c(-9, 3), !grepl("\\[Lords\\]", Bill)) %>%
  mutate(
    # Standardize vote coding
    vote_binary = case_when(
      vote_code == 2 ~ 1,    # Aye
      vote_code == 4 ~ 0,    # No
      TRUE ~ NA_real_       # All others as missing
    ),
    # Create MP IDs
    mp_unique_id = paste0(firstname, "_", surname, "_", mpid),
  
    party_clean = case_when(
      grepl("Con|Conservative", party) ~ "Conservative",
      grepl("Lab|Labour", party) ~ "Labour",
      grepl("LD|Lib Dem", party) ~ "Liberal Democrat",
      grepl("SNP", party) ~ "SNP",
      grepl("PC|Plaid", party) ~ "Plaid Cymru",
      grepl("Green", party) ~ "Green",
      TRUE ~ "Other"
    )
  ) %>%
  
  select(mp_unique_id, firstname, surname, party_clean, year, parliament, vote_binary, voteno)

calculate_yearly_scores <- function(yr, data) {
  yearly_data <- data %>% filter(year == yr)
  
  if(nrow(yearly_data) == 0) return(NULL)
  
  # Create agreement matrix 
  jeremy_votes <- yearly_data %>%
    filter(firstname == "Jeremy", surname == "Corbyn") %>%
    distinct(voteno, jeremy_vote = vote_binary)  # Ensure unique votes
  
  agreement_matrix <- yearly_data %>%
    left_join(jeremy_votes, by = "voteno", relationship = "many-to-many") %>%
    
    group_by(mp_unique_id, voteno) %>%
    summarize(agreement = round(mean(vote_binary == jeremy_vote, na.rm = TRUE))) %>%
    ungroup() %>%
    # Ensure binary values
    mutate(agreement = ifelse(agreement > 0.5, 1, 0)) %>%
    pivot_wider(
      names_from = voteno,
      values_from = agreement,
      values_fill = 0  # Fill missing with 0 
    ) %>%
    column_to_rownames("mp_unique_id") %>%
    as.matrix()
  
  # Filter items with no variance
  keep_items <- which(apply(agreement_matrix, 2, function(x) length(unique(x)) > 1))
  agreement_matrix <- agreement_matrix[, keep_items, drop = FALSE]
  
  if(ncol(agreement_matrix) < 5) {
    warning(paste("Not enough valid votes in", yr))
    return(NULL)
  }
  
  # Run IRT model
  irt_model <- tryCatch(
    ltm::ltm(agreement_matrix ~ z1, IRT.param = TRUE),
    error = function(e) {
      warning(paste("IRT failed for", yr, ":", e$message))
      return(NULL)
    }
  )
  
  if(is.null(irt_model)) return(NULL)
  
  # Extract scores
  scores <- ltm::factor.scores(irt_model, resp.patterns = agreement_matrix)$score.dat %>%
    rownames_to_column("mp_unique_id") %>%
    select(mp_unique_id, z_score = z1) %>%
    mutate(year = yr)
  
  return(scores)
}

# Calculate scores
all_scores <- map_dfr(all_years, ~{
  message("Processing year: ", .x)
  calculate_yearly_scores(.x, combined_data)
}, .progress = TRUE)

# Get all unique years from your combined_data
all_years <- unique(combined_data$year)

all_scores <- map_dfr(all_years, ~{
  message("Processing year: ", .x)
  calculate_yearly_scores(.x, combined_data)
}, .progress = TRUE)

selected_mps <- c("Tony Blair", "Gordon Brown", "David Cameron",
                  "Theresa May", "Jeremy Corbyn", "Keir Starmer")

matching_mps <- unique(all_scores$MPName)[
  grepl("Blair|Brown|Cameron|May|Corbyn|Starmer", 
        unique(all_scores$MPName), ignore.case = TRUE)
]

# Create the plot
ggplot(all_scores %>% 
         filter(MPName %in% matching_mps),  # Use the actual matched names
       aes(x = year, y = z_score, color = MPName)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  labs(title = "MP Ideology Scores Over Time",
       x = "Year", 
       y = "Ideology Score (http://127.0.0.1:42235/graphics/plot_zoom_png?width=594&height=271z)",
       color = "Member of Parliament") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  scale_x_continuous(breaks = seq(min(all_scores$year), max(all_scores$year), by = 2))

```

## Using the tequnique suggested by ionnis

```{r}
election_years <- c(1997, 2001, 2005, 2010, 2015, 2017)

# Function to load and standardize each election period's data
load_election_data <- function(election_year) {
  
  mps <- read.delim(paste0("https://www.publicwhip.org.uk/data/votematrix-", election_year, ".txt"), 
                    skip = 19)
  vm <- read.delim(paste0("https://www.publicwhip.org.uk/data/votematrix-", election_year, ".dat")) %>%
    mutate(date = as.Date(date))
  
  # Process the voting data
  vm_long <- vm %>%
    pivot_longer(cols = starts_with("mpid"), 
                 names_to = "mpid", 
                 values_to = "vote_code") %>%
    mutate(mpid = as.integer(sub("mpid", "", mpid))) %>%
    left_join(mps %>% rename(mpid = 1), by = "mpid") %>%
    mutate(
      election_period = election_year,
      year = lubridate::year(date),
      parliament = case_when(
        election_year == 1997 ~ "1997-2001",
        election_year == 2001 ~ "2001-2005",
        election_year == 2005 ~ "2005-2010",
        election_year == 2010 ~ "2010-2015",
        election_year == 2015 ~ "2015-2017",
        election_year == 2017 ~ "2017-2019"
      )
    )
  
  return(vm_long)
}

# Load all election periods
all_parliaments <- map_dfr(election_years, load_election_data, .progress = TRUE)

combined_data <- all_parliaments %>%
  filter(!vote_code %in% c(-9, 3), !grepl("\\[Lords\\]", Bill)) %>%
  mutate(
  
    vote_binary = case_when(
      vote_code == 2 ~ 1,    # Aye
      vote_code == 4 ~ 0,    # No
      TRUE ~ NA_real_       # All others as missing
    ),
    
    mp_unique_id = paste0(firstname, "_", surname, "_", mpid),
    # Clean party names
    party_clean = case_when(
      grepl("Con|Conservative", party) ~ "Conservative",
      grepl("Lab|Labour", party) ~ "Labour",
      grepl("LD|Lib Dem", party) ~ "Liberal Democrat",
      grepl("SNP", party) ~ "SNP",
      grepl("PC|Plaid", party) ~ "Plaid Cymru",
      grepl("Green", party) ~ "Green",
      TRUE ~ "Other"
    ),
    # Create display name
    display_name = paste(firstname, surname)
  )

# Function to calculate yearly IRT scores
calculate_yearly_scores <- function(yr, data) {
  yearly_data <- data %>% filter(year == yr)
  
  if(nrow(yearly_data) == 0) return(NULL)
  
  # Create agreement matrix
  jeremy_votes <- yearly_data %>%
    filter(firstname == "Jeremy", surname == "Corbyn") %>%
    distinct(voteno, jeremy_vote = vote_binary)  # Ensure unique votes
  
  agreement_matrix <- yearly_data %>%
    left_join(jeremy_votes, by = "voteno", relationship = "many-to-many") %>%
    # Handle duplicates by taking the most common agreement
    group_by(mp_unique_id, voteno) %>%
    summarize(agreement = round(mean(vote_binary == jeremy_vote, na.rm = TRUE))) %>%
    ungroup() %>%
    # Ensure binary values
    mutate(agreement = ifelse(agreement > 0.5, 1, 0)) %>%
    pivot_wider(
      names_from = voteno,
      values_from = agreement,
      values_fill = 0  # Fill missing with 0 (disagreement)
    ) %>%
    column_to_rownames("mp_unique_id") %>%
    as.matrix()
  
  # Filter items with no variance
  keep_items <- which(apply(agreement_matrix, 2, function(x) length(unique(x)) > 1))
  agreement_matrix <- agreement_matrix[, keep_items, drop = FALSE]
  
  if(ncol(agreement_matrix) < 5) {
    warning(paste("Not enough valid votes in", yr))
    return(NULL)
  }
  
  # Run IRT model
  irt_model <- tryCatch(
    ltm::ltm(agreement_matrix ~ z1, IRT.param = TRUE),
    error = function(e) {
      warning(paste("IRT failed for", yr, ":", e$message))
      return(NULL)
    }
  )
  
  if(is.null(irt_model)) return(NULL)
  
  # Extract scores
  scores <- ltm::factor.scores(irt_model, 
                               resp.patterns = agreement_matrix, 
                               method = "EAP")$score.dat %>%
    rownames_to_column("mp_unique_id") %>%
    select(mp_unique_id, z_score = z1) %>%
    mutate(year = yr)
  
  return(scores)
}

# Get all unique years
all_years <- unique(combined_data$year)

# Calculate scores for all years
all_scores <- map_dfr(all_years, ~{
  message("Processing year: ", .x)
  calculate_yearly_scores(.x, combined_data)
}, .progress = TRUE)

# Join back with MP metadata
final_data <- all_scores %>%
  left_join(combined_data %>% 
              select(mp_unique_id, display_name, party_clean) %>%
              distinct(), 
            by = "mp_unique_id")

selected_mps <- c("Tony Blair", "Gordon Brown", "David Cameron",
                  "Theresa May", "Keir Starmer",
                  "John McDonnell", "Diane Abbott", "Boris Johnson")

# Create the visualization
ggplot(final_data %>% 
         filter(display_name %in% selected_mps),
       aes(x = year, y = z_score, color = display_name)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  labs(title = "MP Ideological Alignment with Jeremy Corbyn (1997-2019)",
       subtitle = "Higher scores indicate greater voting alignment",
       x = "Year",
       y = "IRT Alignment Score",
       color = "MP") +
  theme_minimal() +
  theme(legend.position = "bottom",
        plot.title = element_text(face = "bold", size = 14),
        plot.subtitle = element_text(size = 12)) +
  scale_x_continuous(breaks = seq(min(final_data$year), max(final_data$year), by = 2)) +
  scale_color_brewer(palette = "Set1")

# Save the plot
ggsave("mp_alignment_scores.png", width = 10, height = 6, dpi = 300)

# Save the data
write_csv(final_data, "mp_alignment_scores.csv")

```


## Plot using csv rather than simulation

```{r}

final_data <- read_csv("mp_alignment_scores.csv")


selected_mps <- c("Tony Blair", "Gordon Brown", "David Cameron",
                  "Theresa May", "Keir Starmer",
                  "John McDonnell", "Diane Abbott", "Boris Johnson")

# Create the visualization
ggplot(final_data %>% 
         filter(display_name %in% selected_mps),
       aes(x = year, y = z_score, color = display_name)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  labs(title = "MP Ideological Alignment with Jeremy Corbyn (1997-2019)",
       subtitle = "Higher scores indicate greater voting alignment",
       x = "Year",
       y = "IRT Alignment Score",
       color = "MP") +
  theme_minimal() +
  theme(legend.position = "bottom",
        plot.title = element_text(face = "bold", size = 14),
        plot.subtitle = element_text(size = 12)) +
  scale_x_continuous(breaks = seq(min(final_data$year), max(final_data$year), by = 2)) +
  scale_color_brewer(palette = "Set1")

# Save the plot
ggsave("mp_alignment_scores_from_csv.png", width = 10, height = 6, dpi = 300)

```




